<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blueocean.azbrain.dao.TopicMapper">
  <resultMap id="topic" type="com.blueocean.azbrain.model.Topic">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="content" jdbcType="VARCHAR" property="content" />
    <result column="icon" jdbcType="VARCHAR" property="icon" />
    <result column="follower_num" jdbcType="INTEGER" property="followerNum" />
    <result column="consulted_num" jdbcType="INTEGER" property="consultedNum" />
    <result column="specialist_num" jdbcType="INTEGER" property="specialistNum" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="create_by" jdbcType="INTEGER" property="createBy" />
    <result column="status" jdbcType="CHAR" property="status" />

    <result column="updated_article_num" jdbcType="INTEGER" property="updatedArticleNum" />
  </resultMap>

  <sql id="Base_Column_List">
    id, title, content, icon, follower_num, consulted_num, specialist_num, create_time, create_by, status
  </sql>

  <select id="get" parameterType="java.lang.Integer" resultMap="topic">
    select 
    <include refid="Base_Column_List" />
    from azbrain_topic
    where id = #{id,jdbcType=INTEGER}
  </select>

  <insert id="insert" parameterType="com.blueocean.azbrain.model.Topic" useGeneratedKeys="true" keyProperty="id">
    insert into azbrain_topic (
      title,
      content,
      icon,
      follower_num,
      consulted_num,
      create_time,
      create_by,
      status)
    values (
      #{title,jdbcType=VARCHAR},
      #{content,jdbcType=VARCHAR},
      #{icon,jdbcType=VARCHAR},
      #{followerNum,jdbcType=INTEGER},
      #{consultedNum,jdbcType=INTEGER},
      #{createTime,jdbcType=TIMESTAMP},
      #{createBy,jdbcType=INTEGER},
      #{status,jdbcType=CHAR})
  </insert>

  <update id="edit" parameterType="com.blueocean.azbrain.model.Topic">
    UPDATE azbrain_topic
    SET
      title = #{title},
      content = #{content},
      icon = #{icon}
    WHERE
      id = #{id}
  </update>

  <select id="userFollowTopics" parameterType="java.util.Map" resultMap="topic">
    SELECT
      t.id,
      title,
      content,
      icon,
      follower_num,
      consulted_num,
      specialist_num,
      uft.updated_article_num,
      create_time,
      create_by,
      status
    FROM
      azbrain_topic t
    INNER JOIN
      azbrain_user_follow_topic uft
    ON
      t.id = uft.topic_id
    WHERE
      uft.user_id = #{userId,jdbcType=INTEGER}
    ORDER BY create_time DESC
  </select>

  <select id="followNum" resultType="java.lang.Integer">
    SELECT COUNT(0)
    FROM
      azbrain_user_follow_topic
    WHERE
      user_id = #{userId}
    AND
      topic_id = #{topicId}
  </select>

  <insert id="follow" parameterType="com.blueocean.azbrain.model.UserFollowTopic">
    INSERT INTO azbrain_user_follow_topic(
      user_id,
      topic_id,
      follow_time)
    VALUES(
      #{userId},
      #{topicId},
      #{followTime})
    ;
    UPDATE azbrain_topic
    SET
      follower_num = follower_num + 1
    WHERE
      id = #{topicId}
    ;
  </insert>

  <delete id="unfollow">
    DELETE FROM
      azbrain_user_follow_topic
    WHERE
      user_id = #{userId}
    AND
      topic_id = #{topicId}
    ;
    UPDATE azbrain_topic
    SET
      follower_num = follower_num - 1
    WHERE
      id = #{topicId}
    AND
      follower_num > 0
    ;
  </delete>

  <update id="incrConsultedNum">
    UPDATE
      azbrain_topic
    SET
      consulted_num = consulted_num + 1
    WHERE
      id = #{topicId}
  </update>

  <update id="resetUpdatedArticleNum">
    UPDATE
      azbrain_user_follow_topic
    SET
      updated_article_num = 0
    WHERE
      user_id = #{userId}
    AND
      topic_id = #{topicId}
  </update>

  <update id="increaseUpdatedArticleNum">
    UPDATE
      azbrain_user_follow_topic
    SET
      updated_article_num = updated_article_num + 1
    WHERE
      topic_id = #{topicId}
  </update>

  <!-- manager -->

  <select id="pageTopics" resultMap="topic">
    SELECT
    <include refid="Base_Column_List" />
    FROM
      azbrain_topic
    WHERE
      status = '00'
    <if test="title != null">
      AND title LIKE CONCAT('%',#{title},'%')
    </if>
    <if test="startTime != null">
      <![CDATA[ AND create_time >= #{startTime} ]]>
    </if>
    <if test="endTime != null">
      <![CDATA[ AND create_time <= #{endTime} ]]>
    </if>
  </select>

  <update id="delete">
    UPDATE
      azbrain_topic
    SET
      status = '99'
    WHERE
      id = #{topicId}
  </update>

  <insert id="insertTopicSpecialist">
    INSERT INTO azbrain_topic_specialist(
      topic_id,
      user_id,
      create_time
    )
    VALUES(
      #{topicId},
      #{userId},
      now()
    )
    ;
    UPDATE azbrain_topic SET specialist_num = specialist_num + 1
    ;
  </insert>

  <delete id="deleteTopicSpecialist">
    DELETE FROM
      azbrain_topic_specialist
    WHERE
      topic_id = #{topicId}
    <if test="userId != null">
      AND user_id = #{userId}
      ;
      UPDATE azbrain_topic SET specialist_num = specialist_num - 1
      ;
    </if>
    <if test="userId == null">
      ;
      UPDATE azbrain_topic SET specialist_num = 0
      ;
    </if>
  </delete>
</mapper>